name: Validate Data Points

on:
  push:
    paths:
      - 'data_points/**'
  pull_request:
    paths:
      - 'data_points/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Allow time for Docker image builds on first run
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for changed files detection

      - name: Detect changed files
        id: changed-files
        run: |
          set -e
          # Detect changed JSON files in data_points/ directory
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            echo "Comparing PR: $BASE_SHA..$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB $BASE_SHA $HEAD_SHA | grep '^data_points/.*\.json$' || true)
          else
            # For pushes, compare against previous commit (if exists)
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              echo "Comparing push: HEAD~1..HEAD"
              CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB HEAD~1 HEAD | grep '^data_points/.*\.json$' || true)
            else
              # First commit - check all files in data_points/
              echo "First commit - checking all data_points files"
              CHANGED_FILES=$(find data_points -name "*.json" 2>/dev/null || true)
            fi
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "ℹ️ No changed JSON files found in data_points/"
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Found changed files:"
            echo "$CHANGED_FILES"
            echo "changed=true" >> $GITHUB_OUTPUT
            # Convert newlines to spaces
            FILES_QUOTED=$(echo "$CHANGED_FILES" | tr '\n' ' ' | sed 's/ $//')
            echo "files=$FILES_QUOTED" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no changes
        if: steps.changed-files.outputs.changed != 'true'
        run: |
          echo "✅ No data point files changed. Skipping validation."
          echo "This workflow only runs when data_points/** files are modified."

      - name: Set up Python
        if: steps.changed-files.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install UV
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          pip install uv

      - name: Install dependencies
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          uv sync

      - name: Validate data points
        id: validate
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No files to validate"
            exit 0
          fi
          
          echo "Validating changed data points..."
          echo "Files to validate: $CHANGED_FILES"
          echo ""
          echo "ℹ️  Note: First run may take 20-40 minutes to build Docker images."
          echo "   Subsequent runs will be faster as images are cached."
          echo ""
          
          # Run validator
          # Exit code 1 = validation failed (expected for invalid data points)
          # Exit code 0 = validation passed (expected for valid data points)
          uv run python -m swe_bench_validator $CHANGED_FILES --verbose

      - name: Report validation results
        if: always() && steps.changed-files.outputs.changed == 'true'
        run: |
          if [ "${{ steps.validate.outcome }}" = "success" ]; then
            echo "✅ All data points validated successfully!"
            echo ""
            echo "All tests passed. The data point is valid."
          else
            echo "❌ Validation failed. Please check the logs above for details."
            echo ""
            echo "Possible reasons:"
            echo ""
            echo "1. Docker images not built yet (first run):"
            echo "   - First run takes 20-40 minutes to build Docker images"
            echo "   - This is expected SWE-bench behavior"
            echo "   - Subsequent runs will be faster"
            echo ""
            echo "2. Invalid data point (expected failure):"
            echo "   - Patch fails to apply to the repository"
            echo "   - FAIL_TO_PASS tests still fail after applying the patch"
            echo "   - PASS_TO_PASS tests break after applying the patch"
            echo ""
            echo "3. Docker evaluation errors:"
            echo "   - Check Docker logs for details"
            echo "   - Ensure sufficient resources (disk space, memory)"
            echo ""
            echo "Check the validation logs above for the specific error."
          fi
